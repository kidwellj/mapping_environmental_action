---
title:  "Mapping Environmental Action in Scotland"
abstract:    
# thanks: "Replication files are available on the author's Github account (https://github.com/kidwellj/mapping_environmental_action). **Current version**: `r format(Sys.time(), '%B %d, %Y')`
style:  jeremy1
author: "[Jeremy H. Kidwell](http://jeremykidwell.info)"
affiliation: University of Birmingham
institute: University of Birmingham
e-mail: "[j.kidwell@bham.ac.uk](mailto:j.kidwell@bham.ac.uk)"
date: "`r Sys.Date()`"
bibliography: biblio.bib
linkcolor: black
geometry: margin=1in
# fontfamily: mathpazo
fontsize: 11pt
output:
  html_document:
    theme: readable
    keep_md: true
    code_folding: hide
    self_contained: true
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    fig_retina: 1
  pdf_document:
    toc: false
    keep_tex: true
    number_sections: true
    fig_caption: true
    citation_package: natbib
    latex_engine: xelatex
  always_allow_html: yes
  
---

```{r setup, include=FALSE}
require(knitr)
require(kableExtra)
knitr::opts_chunk$set(fig.path='figures/', warning=FALSE, echo=FALSE, message=FALSE, dpi=300, fig.width=7)
# TODO: consider implementing knitcitations - https://github.com/cboettig/knitcitations
# TODO: fix simultaneous output towards PDF, see here: https://stackoverflow.com/questions/23621012/display-and-save-the-plot-simultaneously-in-r-rstudio
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
## Default repo
# setwd("/Users/jeremy/gits/mapping_environmental_action")
# setwd("/Users/kidwellj/OneDrive\ -\ bham.ac.uk/writing/201708_mapping_environmental_action")

# Set repository to be new standard, e.g. cloud server. 
# This will avoid a dialogue box if packages are to be installed for below on first run.
local({r <- getOption("repos")
       r["CRAN"] <- "https://cloud.r-project.org" 
       options(repos=r)
})
# TODO: remove sp etc. once sf is fully implemented
require(RCurl) # used for fetching reproducible datasets
require(sf) # new simplefeature data class, supercedes sp in many ways
require(sp) # needed for proj4string, deprecated by sf()
require(rgdal) # deprecated by sf()
require(GISTools) # deprecated by sf()
require(rgeos) # deprecated by sf()
require(maptools)
require(ggplot2)
require(tmap) # using as an alternative to base r graphics and ggplot for geospatial plots
# require(ggmap)
require(broom) # required for tidying SPDF to data.frame for ggplot2
require(tidyr)  # using for grouped bar plot
require(plyr)
require(dplyr)
require(reshape2)  # using for grouped bar plot
require(scales)
# require(sqldf) # using sqldf to filter before loading very large data sets
require(plotly) # allows for export of plots to dynamic web pages
require(gtable) # more powerful package for multi-plot layouts, not necessary for knitr
require(showtext) # for loading in fonts
require(extrafont) # font support

# Set up local workspace:
if (dir.exists("data") == FALSE) {
  dir.create("data") 
}
if (dir.exists("figures") == FALSE) {
  dir.create("figures") 
}
if (dir.exists("derivedData") == FALSE) {
  dir.create("derivedData")
}

# Define Coordinate Reference Systems (CRS) for later use
# Note: I've used British National Grid (27000) in this paper, but have found that 
# it is falling out of use in many cases, so will be defaulting to WGS84 in future 
# data-sets and papers.

# TODO: make canonical CRS definitions and use consistently; remove proj4string(admin_lev1) and other similar instances below. 
wgs84 <- "+proj=longlat +datum=WGS84"
bng_old <- "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894"
bng <- "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs"
osgb36 <- "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894"

# Note, shifting to EPSG codes given the usage of this approach with sf()
bng_epsg <- CRS("+init=epsg:27700")
osgb36 <- CRS("+init=epsg:7405")
wgs84_epsg <- CRS("+init=epsg:4326")

# Configure fonts for plots below

## Loading Google fonts (http://www.google.com/fonts)
# font_add_google("Merriweather", "merriweather")
# The following will load in system fonts (uncomment and run as needed on first execution)
# font_import(pattern="[A/a]rial", prompt=FALSE)
```

# Introduction[^15541312]

Until recently, environmentalism has been treated by governments and environmental charities as a largely secular concern. In spite of the well-developed tradition of "eco-theology" which began in earnest in the UK in the mid-twentieth century (and which has many precursors in previous centuries), third-sector groups and governments, particularly in Britain and Europe, have largely ignored religious groups as they have gone about their business crafting agendas for behaviour change, developing funding programmes, and developing platforms to mitigate ecological harm, motivate consumers and create regulation regimes. That this has changed is evidenced by the fact that several prominent non-religious environmental groups have commissioned studies and crafted outreach programmes to persons with a particular faith tradition or to "spiritual communities" including RSPB (2013) and the Sierra Club USA (2008).[^158261118] Further, since 2008, the Scottish Government has provided a significant portion of funding for the ecumenical charity, Eco-Congregation Scotland, which works to promote literacy on environmental issues in religious communities in Scotland and helps to certify congregations under their award programme. What is not well known, however, even by these religious environmental groups themselves, is whether or how their membership might be different from other environmental groups. This study represents an attempt to illuminate this new interest with some more concrete data about religious groups in Scotland and how they may differ from non-religious counterparts.

# Eco-Congregation Scotland: The Basics

```{r load_ecs_data, message=FALSE, warning=FALSE}
# read in Eco-Congregation Scotland data and-------------------
# ...turn it into a SpatialPointsDataFrame---------------------
# TODO: upload ECS-GIS-Locations_3.0.csv to zenodo repository, i.e.
ecs <- read.csv("data/ECS-GIS-Locations_3.0.csv", comment.char="#")
ecs_sf <- st_as_sf(ecs, coords = c("X", "Y"), crs=27700)
# unnecessary with advent of sf (above)
coordinates(ecs) <- c("X", "Y")
proj4string(ecs) = CRS(bng)
```

There are `r length(ecs)` eco-congregations in Scotland. By some measurements, particularly in terms of individual sites and possibly also with regards to volunteers, this makes Eco-Congregation Scotland one of the largest environmental third-sector groups in Scotland.[^159141043] 

In seeking to conduct GIS and statistical analysis of ECS, it is important to note that there some ways in which these sites are statistically opaque. Our research conducted through interviews at a sampling of sites and analysis of a variety of documents suggests that there is a high level of diversity both in terms of the number of those participating in environmental action and the types of action underway at specific sites. Work at a particular site can also ebb and flow over the course of time. Of course, as research into other forms of activism and secular environmental NGOs has shown, this is no different from any other third sector volunteer group. Variability is a regular feature of groups involved in activism and/or environmental concern. 

For the sake of this analysis, we took each Eco-Congregation Scotland site to represent a point of analysis as if each specific site represented a community group which had "opted-in" on environmental concern. On this basis, in this section, in the tradition of human geography, we "map" environmental action  among religious communities in Scotland a variety of ways. This is the first major geographical analysis of this kind conducted to date in Europe. We measure the frequency and location of ECS sites against a variety of standard geo-referenced statistical data sets, seeking to provide a statistical and geographically based assessment of the participation of religious groups in relation to the following:

- Location within Scotland
- Religious affiliation
- Relation to the Scottish Index of Multiple Deprivation (SIMD)
- Relation to the 8-Fold Scottish Government Urban-Rural Scale 
- Proximity to "wilderness" (based on several different designations)

For the sake of comparison, we also measured the geographical footprint of two other forms of community group in Scotland, (1) Transition Towns (taking into account their recent merge with Scotland Communities Climate Action Network) and (2) member groups of the Development Trust Association Scotland ("DTAS"). These two groups provide a helpful basis for comparison as they are not centralised and thus have a significant geographical dispersion across Scotland. They also provide a useful comparison as transition is a (mostly) non-religious environmental movement, and community development trusts are not explicitly linked to environmental conservation (though this is often part of their remit), so we have a non-religious point of comparison in Transition and a non-environmental point of comparison with DTAS

# Technical Background

Analysis was conducted using QGIS 2.8 and R `r getRversion()`, and data-sets were generated in CSV format.[^15541313] To begin with, I assembled a data set consisting of x and y coordinates for each congregation in Scotland and collated this against a variety of other specific data. Coordinates were checked by matching UK postcodes of individual congregations against geo-referencing data in the Office for National Statistics postcode database. In certain instances a single "congregation" is actually a series of sites which have joined together under one administrative unit. In these cases, each site was treated as a separate data point if worship was held at that site at least once a month, but all joined sites shared a single unique identifier. As noted above, two other datasets were generated for the sake of comparative analysis.[^177171536] These included one similar Environmental Non-Governmental Organisation (ENGO) in Scotland (1) Transition Scotland (which includes Scotland Communities Climate Action Network);[^15541342] and another community-based NGO, Scottish Community Development Trusts.[^158261232] As this report will detail, these three overlap in certain instances both literally and in terms of their aims, but each also has a separate identity and footprint in Scotland. Finally, in order to normalise data, we utilised the PointX POI dataset which maintains a complete database of Places of Worship in Scotland.[^15541614]

# Background and History of Eco-Congregation Scotland

Eco-Congregation Scotland began a year before the official launch of Eco-Congregation England and Wales, in 1999, as part of an effort by Kippen Environment Centre (later renamed to Forth Environment Link, or "FEL") a charity devoted to environmental education in central Scotland[^158261210] to broaden the scope of its environmental outreach to churches in central Scotland.[^15826124] Initial funding was provided, through Kippen Environment Centre by way of a "sustainable action grant" (with funds drawn from a government landfill tax) through a government programme called Keep Scotland Beautiful (the Scottish cousin of Keep Britain Tidy). After this initial pilot project concluded, the Church of Scotland provided additional funding for the project in the form of staff time and office space. Additional funding a few years later from the Scottish Government helped subsidise the position of a business manager, and in 2011 the United Reformed Church contributed additional funding which subsidised the position of a full-time environmental chaplain for a 5-year term, bringing the total staff to five.

```{r calculate_ecs_by_year, message=FALSE, warning=FALSE}
# Tidy up date fields and convert to date data type
ecs$registration <- as.Date(ecs$registration, "%Y-%m-%d")
# TODO: Fix issues here with R complaining that "character string is not in a std...
# ecs$award1 <- as.Date(ecs$award1)
# ecs$award2 <- as.Date(ecs$award2)
# ecs$award3 <- as.Date(ecs$award3)
# ecs$award4 <- as.Date(ecs$award4)
# TODO: add "R" to command in paragraph below once this is resolved, do search for all non 'r instances
ecs_complete_cases <- ecs[complete.cases(ecs$year_begun),]
```

The programme launched officially in 2001 at Dunblane Cathedral in Stirling and by 2005 the project had `r length(ecs_complete_cases[ecs_complete_cases$year_begun < 2006, ])` congregations registered to be a part of the programme and 25 which had completed the curriculum successfully and received an Eco-Congregation award. By 2011, the number of registrations had tripled to `r length(ecs_complete_cases[ecs_complete_cases$year_begun < 2012, ])` and the number of awarded congregations had quadrupled to `sum(ecs$award1 < "01/01/2012", na.rm=TRUE)`. This process of taking registrations and using a tiered award or recognition scheme is common to many voluntary organisations. The ECS curriculum was developed in part by consulting the Eco-Congregation England and Wales materials which had been released just a year earlier in 1999, though it has been subsequently revised, particularly with a major redesign in 2010. In the USA, a number of similar groups take a similar approach including Earth Ministry (earthministry.org) and Green Faith (greenfaith.org). 

In the case of Eco-Congregation Scotland, congregations are invited to begin by "registering" their interest in the programme by completing a basic one-sided form. The next step requires the completion of an award application, which includes a facilitated curriculum called a "church check-up" and after an application is submitted, the site is visited and assessed by third-party volunteer assessors. Sites are invited to complete additional applications for further awards which are incremental (as is the application process). Transition communities, at least in the period reflected on their map, go through a similar process (though this does not involve the use of a supplied curriculum) by which they are marked first as "interested," become "active" and then gain "official" status.[^1554162]

# Representation by Regional Authorities (Council Areas) {.tabset}

```{r import_admin_data, message=FALSE, warning=FALSE, include=FALSE}
# read in polygon for Scottish admin boundaries
# TODO: upload bundle of admin data to new zenodo repository and alter below to use new URLs
# TODO: need to remove readOGR below once st_read is confirmed to be working as sf

if (file.exists("data/scotland_ca_2010.shp") == FALSE) {
download.file("https://borders.ukdataservice.ac.uk/ukborders/easy_download/prebuilt/shape/Scotland_ca_2010.zip", 
              destfile = "data/Scotland_ca_2010.zip")
unzip("data/Scotland_ca_2010.zip", exdir = "data")
}
admin_lev1 <- readOGR("./data", "scotland_ca_2010") 
admin_lev1_sf <- st_read("data/scotland_ca_2010.shp")

# read in polygon for intermediate admin boundary layers
if (file.exists("data/scotland_parlcon_2011.shp") == FALSE) {
download.file("http://census.edina.ac.uk/ukborders/easy_download/prebuilt/shape/Scotland_parlcon_2011.zip", 
              destfile = "data/Scotland_parlcon_2011.zip")
unzip("data/Scotland_parlcon_2011.zip", exdir = "data")
}
admin_lev2 <- readOGR("./data", "scotland_parlcon_2011")
admin_lev2_sf <- st_read("data/scotland_parlcon_2011.shp")
```

```{r import_groups_data, message=FALSE, warning=FALSE, include=FALSE}
# read in Transition Towns data and turn it into a SpatialPointsDataFrame
transition_wgs <- read.csv(text=getURL("https://zenodo.org/record/165519/files/SCCAN_1.4.csv"))
coordinates(transition_wgs) <- c("X", "Y")
proj4string(transition_wgs) <- CRS(wgs84)
transition <- spTransform(transition_wgs, bng)
transition_sf <- st_as_sf(transition, coords = c("X", "Y"), crs=27700)

# read in all_churches data (data set generated by Jeremy Kidwell to replace PointX data used from Ordnance Survey)
# TODO: need to remove all data points which are outside BNG area to resolve error
# also need to make symmetrical with ECS denominations, add Methodist 
# churches, remove nazarene and salvation army
 
# churches_all <- read.csv("data/all_churches_0.9.csv")
# churches_all_clean<-churches_all[complete.cases(churches_all),]
# churches_all_null<-churches_all[!complete.cases(churches_all),]
# coordinates(churches_all) <- c("X", "Y")
# proj4string(churches_all) <- proj4string(admin_lev1)

# read in pointX data and turn it into a SpatialPointsDataFrame
pow_pointX <- read.csv("./data/poi_2015_12_scot06340459.csv", sep="|")
coordinates(pow_pointX) <- c("feature_easting", "feature_northing")
# TODO: need to alter to draw from wgs84 or bng defined in preamble above
proj4string(pow_pointX) <- proj4string(admin_lev1)
pow_pointX_sf <- st_as_sf(pow_pointX, coords = c("X", "Y"), crs=27700)

# read in Scottish Community Dev. trust data and turn it into a SpatialPointsDataFrame
dtas <- read.csv("data/community-dev-trusts-2.6.csv")
coordinates(dtas) <- c("X", "Y")
proj4string(dtas) <- proj4string(admin_lev1)
dtas_sf <- st_as_sf(dtas, coords = c("X", "Y"), crs=27700)

# read in permaculture data and turn it into a SpatialPointsDataFrame
permaculture <- read.csv("data/permaculture_scot-0.8.csv")
coordinates(permaculture) <- c("X", "Y")
proj4string(permaculture) <- proj4string(admin_lev1)
permaculture_sf <- st_as_sf(permaculture, coords = c("X", "Y"), crs=27700)
```

```{r process_admin_data}
# TODO: Code below augments existing dataframes to run calculations and add columns with point counts per polygon, 
# percentages, and normalising data. I'm pretty sure this can all be done inline under create_admin_ecs_choropleth 
# code chunk without adding new columns to dataframes here, but how?!

# This code will generate a table of frequencies for each spatialpointsdataframe in admin
# calculate count of ECS for fields in admin and provide percentages
# JK Note: need to convert from poly.counts, which uses sp() to st_covers() which uses sf() - cf. https://stackoverflow.com/questions/45314094/equivalent-of-poly-counts-to-count-lat-long-pairs-falling-inside-of-polygons-w#45337050

admin_lev1$ecs_count <- poly.counts(ecs,admin_lev1)
admin_lev1$ecs_percent<- prop.table(admin_lev1$ecs_count)
# calculate count of places of worship in PointX db for fields in admin and provide percentages
admin_lev1$pow_count <- poly.counts(pow_pointX,admin_lev1)
admin_lev1$pow_percent<- prop.table(admin_lev1$pow_count)
# calculate count of Transition for fields in admin and provide percentages
admin_lev1$transition_count <- poly.counts(transition,admin_lev1)
admin_lev1$transition_percent<- prop.table(admin_lev1$transition_count)
# calculate count of dtas for fields in admin and provide percentages
admin_lev1$dtas_count <- poly.counts(dtas,admin_lev1)
admin_lev1$dtas_percent<- prop.table(admin_lev1$dtas_count)
# calculate count of permaculture for fields in admin and provide percentages
admin_lev1$permaculture_count <- poly.counts(permaculture,admin_lev1)
admin_lev1$permaculture_percent<- prop.table(admin_lev1$permaculture_count)

# run totals for intermediate boundaries level 2
# This code will generate a table of frequencies for each spatialpointsdataframe in admin_lev2
# calculate count of ECS for fields in admin_lev2 and provide percentages
admin_lev2$ecs_count <- poly.counts(ecs,admin_lev2)
admin_lev2$ecs_percent<- prop.table(admin_lev2$ecs_count)
# calculate count of places of worship in PointX db for fields in admin_lev2 and provide percentages
admin_lev2$pow_count <- poly.counts(pow_pointX,admin_lev2)
admin_lev2$pow_percent<- prop.table(admin_lev2$pow_count)
# calculate count of Transition for fields in admin_lev2 and provide percentages
admin_lev2$transition_count <- poly.counts(transition,admin_lev2)
admin_lev2$transition_percent<- prop.table(admin_lev2$transition_count)
# calculate count of dtas for fields in admin_lev2 and provide percentages
admin_lev2$dtas_count <- poly.counts(dtas,admin_lev2)
admin_lev2$dtas_percent<- prop.table(admin_lev2$dtas_count)
# calculate count of permaculture for fields in admin_lev2 and provide percentages
admin_lev2$permaculture_count <- poly.counts(permaculture,admin_lev2)
admin_lev2$permaculture_percent<- prop.table(admin_lev2$permaculture_count)

# Import csv with population data for each level of administrative subdivision and join to spatialdataframe

# Placeholder for England parish data for later implementation
# download.file("http://census.edina.ac.uk/ukborders/easy_download/prebuilt/shape/England_cp_1991.zip", destfile = "parishes/parishes-1991.zip")
# unzip("parishes/parishes-1991.zip", exdir = "parishes")
# parishes <- rgdal::readOGR(dsn = "parishes", "england_cp_1991")

# TODO - consider adapting to use ONS mid-year statistics: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland

# Load population statistics for normalising data by population and merge with admin_lev1
admin_lev1_pop <- read.csv("./data/scotland_admin_2011pop.csv")
admin_lev1 <- merge(x=admin_lev1, y=admin_lev1_pop, by.x = "code", by.y = "CODE")
# Convert number stored as string with a comma to an integer
admin_lev1$X2011_pop <- as.numeric(gsub(",", "", admin_lev1@data$X2011_pop))
# Calculate counts as percentages of total for normalising below
admin_lev1$pop_percent<- prop.table(admin_lev1$X2011_pop)
admin_lev1$pow_percent<- prop.table(admin_lev1$pow_count)
# Normalise ecs_count using population figures (using ArcGIS method)
admin_lev1$ecs_count_popnorm <- admin_lev1$ecs_count * admin_lev1$pop_percent
# Normalise ecs_count using places of worship counts (using ArcGIS method)
admin_lev1$ecs_count_pownorm <- admin_lev1$ecs_count * admin_lev1$pow_percent

# Preserve scale
admin_lev1$ecs_count_popnorm_scaled <- admin_lev1$ecs_count_popnorm*(sum(admin_lev1$ecs_count)/sum(admin_lev1$ecs_count_popnorm))
admin_lev1$ecs_count_pownorm_scaled <- admin_lev1$ecs_count_pownorm*(sum(admin_lev1$ecs_count)/sum(admin_lev1$ecs_count_pownorm))

# Load population statistics for normalising data by population on admin_lev2
admin_lev2_pop <- read.csv("./data/scotland_and_wales_const_scotland_2011pop.csv")
admin_lev2 <- merge(x=admin_lev2, y=admin_lev2_pop, by.x = "code", by.y = "CODE")
# Convert number stored as string with a comma to an integer (using data.zone data)
admin_lev2$Data.zone.Population <- as.numeric(gsub(",", "", admin_lev2$Data.zone.Population)) 
# Calculate counts as percentages of total for normalising below
admin_lev2$pop_percent <- prop.table(admin_lev2$Data.zone.Population)
admin_lev2$pow_percent <- prop.table(admin_lev2$pow_count)
# Normalise ecs_count using population figures (using ArcGIS method)
admin_lev2$ecs_count_popnorm <- admin_lev2$ecs_count * admin_lev2$pop_percent
# Normalise ecs_count using places of worship counts (using ArcGIS method)
admin_lev2$ecs_count_pownorm <- admin_lev2$ecs_count * admin_lev2$pow_percent
```

Perhaps the first important question to ask of these groups is, where are they? I calculated the spread of eco-congregations and transition groups across each of the 32 council areas in Scotland. Every council area in Scotland has at least one eco-congregation or transition group). The most are located in `r as.character(admin_lev1$NAME_2[which.max(admin_lev1$ecs_count)])`, with `r max(admin_lev1$ecs_count)`, whereas the mean among all the 32 council areas is `r mean(admin_lev1$ecs_count)`, with a median of `r median(admin_lev1$ecs_count)`, standard deviation of `r sd(admin_lev1$ecs_count)`, and interquartile range of `r IQR(admin_lev1$ecs_count)`. The following choropleth maps show the relative concentration of eco-congregations (indicated by yellow to red). 

Though there are too few eco-congregations and transition groups for a numerically significant representation in any of the intermediate geographies, mapping the concentration of sites by agricultural parishes allows for a more granular visual and I include this for comparison sake. Note, for the sake of a more accurate visual communication, we have also marked out areas of Scotland that are uninhabited with hash marks on the map of agricultural parishes. (*TODO: this will be done in the final draft, once I get my image masking fixed!*).[^15571030]

## Eco-Congregation Scotland groups shown by concentration in administrative regions (NUTS3)

```{r plot_admin_ecs_choropleth, fig.width=4, fig.cap="Figure 1"}
# Note: for more information on EU administrative levels, see here: https://ec.europa.eu/eurostat/web/nuts/national-structures-eu
# TODO: clip choropleth polygons to buildings shapefile (possble superceded by pverlay on lev2)

# Draw initial choropleth map of ECS concentration (using tmap and sf below by default)

tm_shape(admin_lev2) + 
  tm_fill(col = "ecs_count", palette = "Oranges", title = "Concentration of ECS groups") +
  tm_borders(alpha=.5) +
  tm_shape(admin_lev1) +
  tm_borders(lwd=2) +
  # TODO: Change title field "name" to match admin1
  # also consider scaling text size using area #  quick plot example: 
# qtm(World, fill = "income_grp", text = "iso_a3", text.size = "AREA") # use "World$" to see the two attributes: income_grp and iso_a3, text.size= area: text is sized increasingly with coutry area size.
  tm_text("name", size=.8, shadow=TRUE,
          bg.color="white", bg.alpha=.25) +
#  tm_shape(ecs_sf) +
#  tm_dots("red", size = .05, alpha = .4) +
#  tm_scale_bar(position = c("right", "bottom")) +
  tm_style("gray") +
  tm_credits("Data: UK Data Service (OGL)\n& Jeremy H. Kidwell,\nGraphic is CC-by-SA 4.0", 
              size = 0.7, 
              position = c("left", "bottom"),
              just = c("left", "bottom"),
              align = "left") +
  tm_layout(asp = NA,
            frame = FALSE, 
            title = "Figure 1a", 
            title.size = .7,
            legend.title.size = .7,
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

```



```{r plot_admin_ecs_normed_choropleth, fig.width=4, fig.show="hold", fig.cap="Figure 3"}

# Plot out first figure with normalised data: 

tm_shape(admin_lev1) + 
  tm_fill(col = "ecs_count_pownorm_scaled", palette = "Oranges", n = 5) +
  tm_style("gray", title = "Figure 3a") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of ECS groups, data normalised by places of worship", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

# Plot out second figure with normalised data:  

tm_shape(admin_lev1) + 
  tm_fill(col = "ecs_count_popnorm_scaled", palette = "Oranges", n = 5) +
  tm_style("gray", title = "Figure 3b") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of ECS groups, data normalised by places of worship", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )
```

Given the way population and places of worship are unevenly distributed across Scotland it is important to represent data in terms of relative distribution. For this study, we attempted to "normalise" our data in two different ways, (1) as shown by Figure 2 above, by taking population figures from the 2011 census (see data sheet in Appendix A) and (2) by adjusting relative to the number of places of worship in each council region.[^15914204] The latter of these two can yield particularly unexpected results. Thus, of the `r length(pow_pointX)` "places of worship" in Scotland, the highest concentration is actually the `r as.character(admin_lev1$NAME_2[which.max(admin_lev1$pow_count)])` region, with `r max(admin_lev1$pow_count)`, second is `r max( admin_lev1$pow_count[admin_lev1$pow_count!=max(admin_lev1$pow_count)] )` (`r as.character(admin_lev1$NAME_2[which.max( admin_lev1$pow_count[admin_lev1$pow_count!=max(admin_lev1$pow_count)])] )`). Rank of Council Areas by population and number of places of worship is also included in Appendix A.

```{r create_admin_proportions}
# Calculate factors by which ECS representation exceeds rep by population and total pow counts
admin_lev1$ecs_pop_factor <- ((admin_lev1$ecs_percent - admin_lev1$pop_percent) / admin_lev1$pop_percent)*2
admin_lev1$ecs_pow_factor <- ((admin_lev1$ecs_percent - admin_lev1$pow_percent) / admin_lev1$pow_percent)*2
admin_lev1$ecs_transition_factor <- ((admin_lev1$ecs_percent - admin_lev1$transition_percent) / admin_lev1$transition_percent)*2
admin_lev1$ecs_dtas_factor <- ((admin_lev1$ecs_percent - admin_lev1$dtas_percent) / admin_lev1$dtas_percent)*2
```

We can use this data to normalise our figures regarding Eco-Congregation Scotland communities and this draws the presence in Edinburgh of ECS communities into even sharper relief, as Edinburgh, though ranked second in terms of population and fifth in terms of places of worship, ranks first for the presence of all ECS congregations and awarded ECS congregations. However, taking population as the basis for normalisation first, we find that Edinburgh is far from the most prominent outlier. In trying to communicate this difference for a lay-audience, we have chosen to list this difference as a multiplier (i.e. there are 2.x times as many congregations as their share of population and an average figure of congregations might allow for) as this conveys the difference in a straight-forward way. Outliers where the disparity between their relative share of the total ECS footprint and their relative share of population is different by a positive ratio of more than double include the Orkney Islands (3.7 times more eco-congregations than their expected average share based on population), Argyll and Bute (`admin_lev1[CODE=S12000023]$ecs_pop_factor` 4.2x), Stirling (2.76x), and Perthshire and Kinross (2.18x). Interestingly, there are no outliers whose relative share of the total footprint of ECS is double or more in the negative direction (see Appendix A chart for full numbers). 

Turning to the total of `r length(pow_pointX)` "places of worship" in Scotland, we find a slightly different picture of the relative concentration of Eco-Congregations in Scotland. In this case, the outliers are 

Whereas our initial measurements indicated a prominent lead for Edinburgh, by normalising our data in this way we can highlight the stronger-than-expected presence of several others that might otherwise escape notice because they lie in a region with significantly lower population or numerically less places of worship. Taking the PointX data on "places of worship" in Scotland, we find a less dramatic picture, but also a slightly different one. The positive outliers include East Renfrewshire (3.4x) Edinburgh (2.9x), Stirling (2.2), West Lothian (1.9x) and Aberdeen (1.5x). Again, negative outliers are far less dramatic, with only Midlothian possessing a ratio of more than 100% negative difference from the number of "places of worship" at 1.5x *fewer*.

```{r create_admin_barplot, fig.width=4, fig.cap="Figure 4"}
# comvert admin back to dataframe for analysis
admin.df <- data.frame(admin_lev1)

# Goal here is to generate a grouped bar plot; https://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2/
# Need to flatten admin_lev1 based on all the count columns and generate using ggplot

admin_gathered <- gather(data.frame(admin_lev1), key="group_type", value="number", ecs_count, transition_count, dtas_count, permaculture_count)

ggplot(admin_gathered, 
       aes(fill=group_type, y=number, x=name)) + 
  geom_bar(position="dodge", stat="identity") + 
  coord_flip() + 
  labs(
    title = "Figure 4", 
    subtitle ="Comparison of Groups by Admin Region", 
    fill = "Groups") +
  theme(
    legend.position="bottom", 
    legend.title = element_blank(), 
    axis.text.x = element_blank()) +
  scale_color_manual(labels = c("DTAS", "ECS", "Permaculture", "Transition"))
```

## Other environmental groups shown by concentration in administrative regions (NUTS)

```{r create_choropleth_others, fig.width=4, fig.show="hold", fig.cap="Figure 5"}

# TODO: consider switching to two-dimensional kernel densities instead of dots as shown here: https://github.com/mtennekes/tmap/tree/master/demo/LondonCrimes

tm_shape(admin_lev1) + 
  tm_fill(col = "ecs_count", palette = "Oranges", n = 5) +
  tm_shape(ecs_sf) +
  tm_dots("red", size = .02, alpha = .4) +
  tm_style("gray", title = "Figure 5a") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of ECS groups", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

tm_shape(admin_lev1) + 
  tm_fill(col = "transition_count", palette = "Oranges", n = 5) +
  tm_shape(transition_sf) +
  tm_dots("red", size = .02, alpha = .4) +
  tm_style("gray", title = "Figure 5b") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of Transition groups", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

tm_shape(admin_lev1) + 
  tm_fill(col = "dtas_count", palette = "Oranges", n = 5) +
  tm_shape(dtas_sf) +
  tm_dots("red", size = .02, alpha = .4) +
  tm_style("gray", title = "Figure 5c") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of DTAS groups", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

tm_shape(admin_lev1) + 
  tm_fill(col = "permaculture_count", palette = "Oranges", n = 5) +
  tm_shape(permaculture_sf) +
  tm_dots("red", size = .02, alpha = .4) +
  tm_style("gray", title = "Figure 5d") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Concentration of Permaculture groups", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

```

## Cartogram Comparisons

```{r create_cartograms, fig.width=4, fig.show="hold", fig.cap="Figure 6"}

# # TODO: plot as animated chorogram: 
# # https://www.r-graph-gallery.com/331-basic-cartogram/
# # see here for example using sf: https://github.com/dreamRs/topogRam
# # example using tmap here: https://github.com/mtennekes/tmap/raw/8177c5d4e36b480f109474b1ab3f5f073cefe7d5/examples/tm_fill.R
# library(cartogram)
 
# # Make animated:

# https://github.com/thomasp85/gganimate
 
```

We can compare the representation in these various regions against our comparison groups to see how other community-based organisations cluster in Scottish administrative districts. Here there are some significant contrasts. Scottish Community Development trusts are most intensely concentrated in the Highlands and Argyll & Bute. But, this is consistent with all the other categories, Eco-Congregations, Places of Worship, and dtas are all over-represented in this area, varying only by the degree. Edinburgh is different, here we find that Eco-Congregations and Transition projects are over-represented, while dtass are under-represented. Finally, the highlands are another strong contrast, here we find a very strong over-representation by transition towns and dtass while the representation of Eco-Congregations is relatively close to the population share for that area. The two areas of greatest contrast for Eco-Congregations from the other groups are unsurprising, Edinburgh is the location of the ECS offices, while Stirling is the area in which ECS first began (see Appendix B for full data). 

# Christian Denominations #

Eco-Congregation Scotland describes itself as an "ecumenical movement helping local groups of Christians link environmental issues to their faith, reduce their environmental impact and engage with their local community." There are several ties to the Church of Scotland, as the denomination provides office space to Eco-Congregation Scotland in the Church of Scotland complex at 121 George Street in Edinburgh and provides funding for one full-time member of staff. In spite of this, ECS has, from the start, attempted to emphasise its ecumenical aspirations and this is reflected in a wide variety of ways. The name "eco-congregation" is meant to be tradition neutral (in interviews, staff noted how they have sought to avoid names such as "eco-kirk" which would be the more obvious Presbyterian title, or "eco-community" or "eco-church" which might indicate allegiance towards another). Further, the group has a environmental chaplain on their staff whose position is funded by the United Reformed Church, and other members of staff are funded by the Scottish government, and as such, carry no formal affiliation with a religious institution. This diversity and ecumenicism is reflected in a membership which is, though dominated by the Church of Scotland, nevertheless, made up of a range of Christian traditions. 

Though these are not numerically significant, it is important to note that some member congregations describe themselves as ecumenical communities, and others are hybrids reflecting the merging of two traditions. As this ecumenical/hybrid designation involves a small number of the overall total, for the sake of this research, these have been combined into a category called "ecumenical." Further, as research conducted by Church of Scotland statistician Fiona Tweedie has shown, in many Scottish communities with only one church, members of this church will specify their denominational affiliation in a variety of ways (Roman Catholic, Quaker, Methodist, etc.) even though the church and its minister are formally affiliated with the Church of Scotland.[^159142242] So, we should be careful not to assume that the various denominational affiliations of eco-congregations are indicative in an absolute way.

A wide variety of historians and sociologists of religion have noted the regional significance of different Christian denominations in Scotland so we sought to assess the relative distribution and concentration of eco-congregations by denomination. Finding comparative statistics is a complex task, made more complicated by several factors. First, most demographic data on religious belonging in Scotland comes in the form of the 2011 census and as such is far more atomised than this data-set which identifies groups at the level of "congregations" rather than individuals. Equating these two is also complex, as participation by members of congregations can be measured in a variety of ways, there are often a small number of active participants in each eco-congregation group, but may also be a large scale, but passive, support by the wider community. 

So why provide this kind of data (i.e. at the level of individual churches) when more granular data (i.e. at the level of individuals persons) is available in the form of the census and related parallel publications such as the 2008 Scottish Environmental Attitudes survey? We believe that mapping places of worship provides a useful intermediate level of analysis and may complement our more atomised understanding of EA which has been assessed at the level of individual persons to date. Because representation within some administrative areas of Scotland, can lead to a small number of data points, we have kept analysis to a National level and have not provided more specific administrative-area level calculations.

```{r create_ecs_denomination_table}
knitr::kable(summary(ecs@data[["denomination"]]), caption = 'ECS by denomination')
# TODO: Add dataframe with overall church numbers for the UK from "ScottishChurches" dataset by JK
```


As one might expect, there is a strong representation of the Church of Scotland, almost 74% of eco-congregations, with this number remaining the same when we only count awarded sites. We can confirm, on the basis of this analysis that ECS has a disproportional representation by Church of Scotland churches. At the 2002 church census count, it only represented 40.20% of Scottish churches (1666 of 4144 total churches). Similarly, on the 2011 Scottish census, only 32.44% of persons claimed to be members of the Church of Scotland. We can adjust this representation to 60%, if one excludes the 2,445,204 persons (46% of the total on the census) who reported either "no religion" or adherence to a religious tradition not currently represented among the eco-congregation sites. There is a slight over-representation by the United Reformed church, though this seems considerably more dramatic when one takes into account the fact that this is a trebling or more of their overall share of Scottish churches. The URC makes up only sightly more than 1% of church buildings in Scotland and a tiny 0.04% of respondents to the 2011 census. The Scottish Episcopal church hovers right around a proportional representation within ECS. More concerning are the significant underrepresentation by Roman Catholic churches, Baptists, the Free Church of Scotland, and other independent churches. 

While Roman Catholic churches make up just over 10% of the church buildings in Scotland, less than 5% of churches registered as eco-congregations are RC. Even more dramatic is the quartering of baptist churches, and the non-existent representation among the significant group of independent churches and small denominations. These make up nearly 25% of all Scottish churches (over a thousand) and yet only 4 have registered as eco-congregations. We provide several tentative advisories in response to these under-representations in the final section of this paper.

# Eco-Congregations, Urban, Rural and Remote

```{r ur8fold, message=FALSE, warning=FALSE}
# read in relevant polygons for UR8fold scale
if (file.exists("data/SG_UrbanRural_2016.shp") == FALSE) {
download.file("http://sedsh127.sedsh.gov.uk/Atom_data/ScotGov/ZippedShapefiles/SG_UrbanRural_2016.zip", 
              destfile = "data/SG_UrbanRural_2016.zip")
unzip("data/SG_UrbanRural_2016.zip", exdir = "data")
}
# Todo: remove sp datasets when sf revisions are complete. Currently running in parallel
urbanrural <- readOGR("./data", "SG_UrbanRural_2016") 
urbanrural_sf <- st_read("data/SG_UrbanRural_2016.shp")
urbanrural_sf_simplified <- st_simplify(urbanrural_sf)
# TODO: worth considering uploading data to zenodo for long-term reproducibility as ScotGov shuffles this stuff around periodically breaking URLs

# This code will generate a table of frequencies for each spatialpointsdataframe in urbanrural
# calculate count of ECS for fields in urbanrural
urbanrural$ecs_count <- poly.counts(ecs,urbanrural)
urbanrural$ecs_percent<- prop.table(urbanrural$ecs_count)
# calculate count of places of worship in PointX db for fields in urbanrural and provide percentages
urbanrural$pow_count <- poly.counts(pow_pointX,urbanrural)
urbanrural$pow_percent<- prop.table(urbanrural$pow_count)
# calculate count of Transition for fields in urbanrural
urbanrural$transition_count <- poly.counts(transition,urbanrural)
urbanrural$transition_percent<- prop.table(urbanrural$transition_count)
# calculate count of dtas for fields in urbanrural
urbanrural$dtas_count <- poly.counts(dtas,urbanrural)
urbanrural$dtas_percent<- prop.table(urbanrural$dtas_count)
# calculate count of permaculture for fields in urbanrural
urbanrural$permaculture_count <- poly.counts(permaculture,urbanrural)
urbanrural$permaculture_percent<- prop.table(urbanrural$permaculture_count)

```

Rather than bifurcate congregations into an urban/rural dichotomy, for this study we used the Scottish Government's six-point remoteness scale to categorise eco-congregations along a spectrum of highly populated to remote areas. This 8-fold scale (calculated biennially) offers a more nuanced measurement that combines measurements of remoteness and population along the following lines:

1. Large Urban Areas - Settlements of over 125,000 people.
2. Other Urban Areas - Settlements of 10,000 to 125,000 people. 
3. Accessible Small Towns - Settlements of between 3,000 and 10,000 people, and within a 30 minute drive time of a Settlement of 10,000 or more. 
4. Remote Small Towns - Settlements of between 3,000 and 10,000 people, and with a drive time between 30 and 60 minutes to a Settlement of 10,000 or more.
5. Very Remote Small Towns - Settlements of between 3,000 and 10,000 people, and with a drive time of over 60 minutes to a Settlement of 10,000 or more.
6. Accessible Rural Areas - Areas with a population of less than 3,000 people, and within a drive time of 30 minutes to a Settlement of 10,000 or more.
7. Remote Rural Areas - Areas with a population of less than 3,000 people, and with a drive time of between 30 and 60 minutes to a Settlement of 10,000 or more.
8. Very Remote Rural Areas - Areas with a population of less than 3,000 people, and with a drive time of over 60 minutes to a Settlement of 10,000 or more.

The key question which this analysis seeks to answer is whether ECS, or the other groups surveyed, are more concentrated in Urban or Rural areas, so as is the case below with our analysis of deprivation, we are concerned with the outer conditions, i.e. the urban areas (items 1-2) and remote areas (items 7-8).

Of all the groups surveyed in this study, Eco-Congregation Scotland is the most heavily concentrated in large urban areas (33.53%), exceeding by almost 50% the rate for all places of worship (22.96% in large urban areas). Transition is a much more modest 20% and development trusts a bit lower at 15%. It is interesting to note that the rate of ECS concentration in these large urban areas matches the level of overall population distribution (34.5%). On the other end of the scale, Eco-Congregation Scotland is the least concentrated in remote rural areas (with 3.93% on level 7 and 5.44% on level 8 on the urban-rural scale), though again, they correlate roughly to the general population distribution (3.2% and 2.9% respectively). Places of worship outpace both the population of Scotland and the footprint of Eco-Congregation Scotland, with 14.98% in very remote rural areas, but this is exceeded by transition at 16.47% and both by Scottish community development trusts at 32.14%. So while Eco-Congregation Scotland correlates roughly with Scottish population distribution across the urban-rural scale, it has a considerably more urban profile than either of the other two groups surveyed.

```{r create_ur_barplot, fig.width=4, fig.cap="Figure 7"}
# Need to flatten urbanrural based on all the count columns and generate using ggplot

urbanrural_gathered <- gather(data.frame(urbanrural), key="group_type", value="number", ecs_count, transition_count, dtas_count, permaculture_count)

# TODO: switch to stacked percentage plot, see here: https://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2/

ggplot(urbanrural_gathered, 
       aes(fill=group_type, y=number, x=UR8FOLD)) + 
  geom_bar(position="dodge", stat="identity") + 
  coord_flip() + 
  labs(
    title = "Figure 7", 
    subtitle="Comparison of Groups by UrbanRural category", 
    fill = "Groups")
```
## Eco-Congregation Scotland\nconcentrations in Urban Rural 8-fold classifications

```{r create_urbanrural_ecs_chart_choropleth, message=FALSE, warning=FALSE, fig.width=4, fig.cap="Figure 8"}

# Using tmap as an alternative to ggplot and base R graphics

# TODO: Clip shapes to buildings shapefile (use OSM or OS?), using st_difference
# TODO: Double check data licenses for tm_credits
# TODO: Add inset with zoom-in for central belt to bottom of map; cf. https://github.com/mtennekes/tmap/tree/master/demo/USChoropleth and https://geocompr.robinlovelace.net/adv-map.html section 8.2.7

# Generate static plot for printing

tm_shape(urbanrural_sf_simplified) + 
  tm_polygons(col = "UR8FOLD", palette = "BrBG", lwd=0.001, n=8) +
  tm_shape(ecs_sf) +
  tm_dots("red", size = .05, alpha = .4) +
  tm_scale_bar(position = c("left", "bottom")) +
  tm_style("gray", title = "Figure 8") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "UrbanRural 8 Fold Scale", 
            frame = FALSE, 
            title.size = .7, 
            inner.margins = c(0.1, 0.1, 0.05, 0.05)
            )

# Generate new sf shape using bounding box and subset of urbanrural for central belt inset below
# Note: coordinates use BNG as CRS (EPSG: 27700)

centralbelt_region = st_bbox(c(xmin = 224479.2, xmax = 642963.5,
                      ymin = 347475.0, ymax = 711014.5),
                    crs = st_crs(urbanrural_sf)) %>% 
  st_as_sfc()

# Generate code for inset map of central belt

# centralbelt_map = tm_shape(centralbelt_region) + tm_polygons() +
#   tm_shape(st_within(ecs_sf, centralbelt_region)) +
#   tm_dots("red", size = .05, alpha = .4) +
#   tm_shape(nz_region) + tm_borders(lwd = 3) 
# Still need to mod above line
# Stitch together maps using grid()

# library(grid)
# nz_height_map
# print(nz_map, vp = viewport(0.8, 0.27, width = 0.5, height = 0.5))

# Generate dynamic plot for exploring
# TODO: change basemap

# tmap_mode("view")
# tm_shape(urbanrural_sf_simplified) + tm_polygons(col = "UR8FOLD", palette = "BrBG") +
#   tm_shape(ecs_sf) +
#   tm_dots("red", size = .05, alpha = .4, popup.vars = TRUE) +
#   tm_view(alpha = 1, basemaps = "Esri.WorldTopoMap")
  

```


# Wealth, Employment, and Literacy

```{r simd data, message=FALSE, warning=FALSE}
# read in relevant polygons, Scottish Index of Multiple deprivation
if (file.exists("data/sc_dz_11.shp") == FALSE) {
download.file("http://simd.scot/2016/data/simd2016_withgeog.zip", 
              destfile = "data/simd2016_withgeog.zip")
unzip("data/simd2016_withgeog.zip", exdir = "data", junkpaths = TRUE)
}
simd_shapes <- readOGR("./data", "sc_dz_11") 
simd_indicators <- read.csv("./data/simd2016_withinds.csv")
simd_indicators_min <- simd_indicators[c(1,6:17)]
simd_wgs <- merge(x=simd_shapes, y=simd_indicators_min, by.x = "DataZone", by.y = "Data_Zone")
simd <- spTransform(simd_wgs, bng)

# Augment each dataset with relevant (geolocated) columns from SIMD
# assign combined table with SIMD columns to attribute table slot of ecs table
ecs@data=cbind(ecs@data,over(ecs,simd))
# assign combined table with SIMD columns to attribute table slot of ecs table
pow_pointX@data=cbind(pow_pointX@data,over(pow_pointX,simd))
# assign combined table with SIMD columns to attribute table slot of transition table
transition@data=cbind(transition@data,over(transition,simd))
# assign combined table with SIMD columns to attribute table slot of permaculture table
permaculture@data=cbind(permaculture@data,over(permaculture,simd))
# assign combined table with SIMD columns to attribute table slot of dtas table
dtas@data=cbind(dtas@data,over(dtas,simd))

# Augment SIMD with group counts

simd$ecs_count <- poly.counts(ecs,simd)
simd$transition_count <- poly.counts(transition,simd)
simd$dtas_count <- poly.counts(dtas,simd)
simd$permaculture_count <- poly.counts(permaculture,simd)
simd$pow_count <- poly.counts(pow_pointX,simd)

# Generate simplified dataframes with counts for each group
ecs_simd <- data.frame(ecs[c(1,16,25,30:36)])
colnames(ecs_simd)[1] <- "group_name"
ecs_simd$group_type <- "ecs"
transition_simd <- data.frame(transition[c(2,5,14,19:25)])
colnames(transition_simd)[1] <- "group_name"
transition_simd$group_type <- "transition"
dtas_simd <- data.frame(dtas[c(1,5,14,19:25)])
colnames(dtas_simd)[1] <- "group_name"
dtas_simd$group_type <- "dtas"
permaculture_simd <- data.frame(permaculture[c(1,11,20,25:31)])
colnames(permaculture_simd)[1] <- "group_name"
permaculture_simd$group_type <- "permaculture"

# Bind into single long data frame
allgroups_simd <- bind_rows(ecs_simd, transition_simd)
allgroups_simd <- bind_rows(allgroups_simd, dtas_simd)
allgroups_simd <- bind_rows(allgroups_simd, permaculture_simd)

allgroups_gathered <- gather(allgroups_simd, key = "simd_category", value = "rank", Overal_SIMD16_Rank, Income_Domain_2016_Rank, Employment_Domain_2016_Rank, Health_Domain_2016_Rank, Education_Domain_2016_Rank, Geographic_Access_Domain_2016_Rank, Crime_Domain_2016_Rank, Housing_Domain_2016_Rank)
```

## SIMD representation across domains by group {.tabset}

### Jitterplot

```{r create_simd_jitterplot}
# simd jitterplot
# jitterplot option, from Teutonico 2015, p. 63
# https://ggplot2.tidyverse.org/reference/geom_jitter.html
```

### Barplot

```{r create_simd_barplot, fig.width=4, fig.cap="Figure 9"}
# Run plots

# Faceted stacked bar plot

# Sort by SIMD ranks for bar stacking below
allgroups_gathered <- allgroups_gathered[order(allgroups_gathered$simd_category, allgroups_gathered$rank),]

# Set manual x-axis labels
axisLabels.x <- c("Crime", "Education", "Employment","Geographic Access","Health","Housing","Income","Overall Rank")

# Plot
# TODO - tidy facet labels: http://www.cookbook-r.com/Graphs/Facets_(ggplot2)/
# TODO - add pointX, consider filtering out some of the simd_categories
ggplot(data=allgroups_gathered, 
       aes(x=simd_category, y=rank, 
           fill=cut_interval(allgroups_gathered$rank, n = 5))) + 
  geom_bar(stat="identity", position="fill") + 
  facet_grid(~group_type) +
  theme(legend.position="none", axis.text.x = element_text(size=6, angle=90, hjust = 0.95, vjust = 0.2)) +
  scale_x_discrete(labels=axisLabels.x) +
  labs(x = NULL, 
       y = "SIMD Rank (in bins by quantile)", 
       fill = "Groups",
       title = "Figure 9", 
       subtitle="Distribution of Groups across IMD Domains by Rank",
       caption = paste("Jeremy H. Kidwell :: jeremykidwell.info",
                       "Data: UK Data Service (OGL) & Jeremy H. Kidwell",
                       "You may redistribute this graphic under the terms of the CC-by-SA 4.0 license.",
                       sep = "\n"))
  

# write.csv(simd_percents_only, "derivedData/simd_percents_only.csv", row.names=FALSE)
```

### Boxplot


```{r create_simd_boxplot, fig.width=4, fig.cap="Figure 10"}

# simd boxplot

# ggplot(data=allgroups_gathered, aes(x=simd_category, y=rank)) + 
#  geom_boxplot(stat="identity") + 
#  facet_grid(~group_type)

# TODO: add calculations inline to text below using data

```

## Discussing SIMD

Another crucial point of assessment relates to the relation of Eco-Congregation communities to the Scottish Index of Multiple Deprivation. This instrument aggregates a large variety of factors which can lead to deprivation including crime rates, employment levels, access to services (implicating remoteness), and literacy. By assessing ECS, Transition, and dtas against the deprivation scale, we can assess whether eco-congregations fall within particular demographics and also whether the fully aggregated SIMD measurement provides a useful point of comparison for our purposes. The SIMD essentially divides Scotland into 6407 geographic zones and then ranks them based on their relative deprivation. This data set can be split into any number of groups, but for our purposes we have settled on Quintiles, splitting the SIMD data set at every 1302 entries. We then measured where each transition group, ECS, and dtas fell within these zones and calculated how they fell into these five quintiles, from more to least deprived.

The first, and most compelling finding is that, in general Eco-Congregation Scotland and Transition Scotland are both roughly the same and match the level of population distribution in the lowest quintile of the general SIMD measurement. 8% of transition groups and eco-congregation groups which have received awards and 9% of the population are located within this quintile. However, taken in relation to the distribution of places of worship in the lowest quintile, we find that eco-congregations are located at half the rate that places of worship are (15%) and dtass match this much more closely at 14%. Turning towards the top quintile, this pattern also holds, here both transition groups (21%) and eco-congregations (21% and 29% of awarded congregations) depart from the population distribution in this upper quintile (which is 10%). Again, general places of worship (at 11%) and DTASs (at 5%) take the opposite direction. We can say decisively that in communities which have been identified as good candidates for intervention to reduce deprivation, ECS and Transition are less likely, and they are over-represented at the areas which fall into the least deprived quintile.

We can find divergence between transition communities and eco-congregation when we split out SIMD domains. In the lowest quartile, measuring exclusively for the income domain, ECS is more represented (11%) - roughly the same as DTAS (12%), and transition is less (6%) represented. In general (as shown on the chart in Appendix D), these trends hold when representation of our groups are measured within other non-remoteness domains of the SIMD. Our basic conclusion is that transition towns are least likely to operate within the lowest quartile of SIMD and DTASs are most likely, with ECS somewhere in the middle. Given the general disparity against the presence of places of worship, it seems fair to suggest that this might be an area for improvement, perhaps even worth developing a special programme which might target areas in SIMD quartile 1 for eco-congregation outreach. This might be considered particularly in light of the starkest underrepresentation of ECS and transition within the SIMD domain of education, skills, and training.

```{r wilderness_data_prep} 

# 1. Download data for SSSI:

if (file.exists("data/SSSI_SCOTLAND.shp") == FALSE) {
# TODO: get reliable URL for data download
# http://gateway.snh.gov.uk/natural-spaces/dataset.jsp?dsid=SSSI
# download.file("", destfile = "data/SSSI_SCOTLAND_ESRI.zip")
unzip("data/SSSI_SCOTLAND_ESRI.zip", exdir = "data")
}

sssi <- st_read("data/SSSI_SCOTLAND.shp") %>% st_transform(27700)
sssi_sp <- readOGR("./data", "SSSI_SCOTLAND") 
# Generate simplified polygon for plots below
sssi_simplified <- st_simplify(sssi)
# sssi_simplified_sp <- rgeos::gSimplify(sssi_sp, tol=3)


# 2. Download wild land areas:

if (file.exists("data/WILDLAND_SCOTLAND.shp") == FALSE) {
# TODO: get reliable URL for data download
# https://gateway.snh.gov.uk/natural-spaces/dataset.jsp?dsid=WILDLAND
# download.file("", destfile = "data/WILDLAND_SCOTLAND_ESRI.zip")
unzip("data/WILDLAND_SCOTLAND_ESRI.zip", exdir = "data")
}

wildland <- st_read("data/WILDLAND_SCOTLAND.shp") %>% st_transform(27700)
wildland_sp <- readOGR("./data", "WILDLAND_SCOTLAND") 
# Generate simplified polygon for plots below
wildland_simplified <- st_simplify(wildland)


# 3. Download data for National Forest Inventory:

# Note: UK-wide data is here: https://opendata.arcgis.com/datasets/bcd6742a2add4b68962aec073ab44138_0.zip?outSR=%7B%22wkid%22%3A27700%2C%22latestWkid%22%3A27700%7D

if (file.exists("data/National_Forest_Inventory_Woodland_Scotland_2017.shp") == FALSE) {
download.file("https://opendata.arcgis.com/datasets/3cb1abc185a247a48b9d53e4c4a8be87_0.zip?outSR=%7B%22wkid%22%3A27700%2C%22latestWkid%22%3A27700%7D", 
              destfile = "data/National_Forest_Inventory_Woodland_Scotland_2017.zip")
unzip("data/National_Forest_Inventory_Woodland_Scotland_2017.zip", exdir = "data")
}

forestinv <- st_read("data/National_Forest_Inventory_Woodland_Scotland_2017.shp") %>% st_transform(27700)
forestinv_sp <- readOGR("./data", "National_Forest_Inventory_Woodland_Scotland_2017") 
# Generate simplified polygon for plots below
forestinv_simplified <- st_simplify(forestinv)

# Download data for scenic areas
# https://opendata.arcgis.com/datasets/d7f6b987c7224a72a185ce012258d500_23.zip
# International Union for Conservation of Nature (IUCN), Category V Protected Landscapes
# for England: https://environment.data.gov.uk/DefraDataDownload/?mapService=NE/AreasOfOutstandingNaturalBeautyEngland&Mode=spatial

# download.file("https://opendata.arcgis.com/datasets/d7f6b987c7224a72a185ce012258d500_23.zip", destfile = "data/ScenicAreas.zip")
# unzip("data/ScenicAreas.zip", exdir = "data")
# scenicareas <- st_read("data/ScenicAreas.shp")
# scenicareas_sp <- readOGR("./data", "ScenicAreas") 

# Set symmetrical CRS for analysis below (inserted here in order to correct errors, may be deprecated later)
st_crs(sssi) <- 27700
st_crs(ecs_sf) <- 27700
st_crs(pow_pointX_sf) <- 27700
st_crs(dtas_sf) <- 27700
st_crs(transition_sf) <- 27700
st_crs(permaculture_sf) <- 27700


# Define buffer and measure number of ECS groups within 0.5 miles of all SSSI
# CRS uses meters for units, so a buffer for 0.5 miles would use 805 meters)

# Define buffers as lines and polygons for reuse below (as some of these operations take > 10 minutes)
# TODO: Working with simplified polygons here to optimise execution, need to confirm calculations are the same as polygons without simplification (likely!)

sssi_buf50 <- st_buffer(sssi_simplified, dist = 50)
sssi_buf500 <- st_buffer(sssi_simplified, dist = 500)
# Lines offer even more optimised representation suitable for plotting
# TODO: resolve error:
# Error in st_cast.sfc(., to = "LINESTRING") : 
#  use smaller steps for st_cast; first cast to MULTILINESTRING or POLYGON?
# sssi_buf50_lines <- st_union(sssi_simplified) %>% st_buffer(50) %>% 
#   st_cast(to = "MULTILINESTRING") %>% 
#   st_cast(to = "LINESTRING")
# sssi_buf500_lines <- st_union(sssi_simplified) %>% st_buffer(500) %>% 
#   st_cast(to = "MULTILINESTRING") %>% 
#   st_cast(to = "LINESTRING")

wildland_buf50 <- st_buffer(wildland_simplified, dist = 50)
wildland_buf500 <- st_buffer(wildland_simplified, dist = 500)
# Lines offer even more optimised representation suitable for plotting
# wildland_buf50_lines = st_union(wildland_simplified) %>% st_buffer(50) %>% 
#   st_cast(to = "LINESTRING")
# wildland_buf500_lines = st_union(wildland_simplified) %>% st_buffer(500) %>% 
#   st_cast(to = "LINESTRING")

forestinv_buf50 <- st_buffer(forestinv_simplified, dist = 50)
forestinv_buf500 <- st_buffer(forestinv_simplified, dist = 500)
# Lines offer even more optimised representation suitable for plotting
# forestinv_buf50_lines = st_union(forestinv_simplified) %>% st_buffer(50) %>% 
#   st_cast(to = "LINESTRING")
# forestinv_buf500_lines = st_union(forestinv_simplified) %>% st_buffer(500) %>% 
#   st_cast(to = "LINESTRING")

# Calculate number of groups within polygons

# calculate coincidence of ecs points within each polygons and buffers for each
# todo, possibly use st_difference(sssi_buf50, sssi)

# TODO: sort out why these layers aren't inheriting crs
st_crs(wildland) <- 27700
st_crs(wildland_buf50) <- 27700
st_crs(wildland_buf500) <- 27700
st_crs(forestinv) <- 27700
st_crs(forestinv_buf50) <- 27700
st_crs(forestinv_buf500) <- 27700

# TODO: consider subsetting instead here, e.g.:

# plot(lnd, col = "lightgrey") # plot the london_sport object
# sel <- lnd$Partic_Per > 25
# plot(lnd[ sel, ], col = "turquoise", add = TRUE) # add selected zones to map
# from https://gotellilab.github.io/Bio381/StudentPresentations/SpatialDataTutorial.html

ecs_sf_sssi <- st_within(ecs_sf, sssi)
ecs_sf_sssi50m <- st_within(ecs_sf, sssi_buf50)
ecs_sf_sssi500m <- st_within(ecs_sf, sssi_buf500)
ecs_sf_sssibeyond500m <- !(st_within(ecs_sf, sssi_buf500))

ecs_sf_wildland <- st_within(ecs_sf, wildland)
ecs_sf_wildland50m <- st_within(ecs_sf, wildland_buf50)
ecs_sf_wildland500m <- st_within(ecs_sf, wildland_buf500)
ecs_sf_wildlandbeyond500m <- !(st_within(ecs_sf, wildland_buf500))

ecs_sf_forestinv <- st_within(ecs_sf, forestinv)
ecs_sf_forestinv50m <- st_within(ecs_sf, forestinv_buf50)
ecs_sf_forestinv500m <- st_within(ecs_sf, forestinv_buf500)
ecs_sf_forestinvbeyond500m <- !(st_within(ecs_sf, forestinv_buf500))

# TODO: implement more efficient code using do.call() function or sapply() as here https://stackoverflow.com/questions/3642535/creating-an-r-dataframe-row-by-row

# Generate dataframe based on SSSI buffers

# Calculate incidence of ecs within SSSI and within buffers at 50/500m
ecs_sssi_row <- c(sum(apply(st_within(ecs_sf, sssi_simplified, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, sssi_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, sssi_buf500, sparse=FALSE), 1, any)))

pow_sssi_row <- c(sum(apply(st_within(pow_pointX_sf, sssi, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, sssi_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, sssi_buf500, sparse=FALSE), 1, any)))

dtas_sssi_row <- c(sum(apply(st_within(dtas_sf, sssi, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, sssi_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, sssi_buf500, sparse=FALSE), 1, any)))

transition_sssi_row <- c(sum(apply(st_within(transition_sf, sssi, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, sssi_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, sssi_buf500, sparse=FALSE), 1, any)))

permaculture_sssi_row <- c(sum(apply(st_within(permaculture_sf, sssi, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, sssi_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, sssi_buf500, sparse=FALSE), 1, any)))

# Generate dataframe from rows based on counts
sssi_counts <- rbind(ecs_sssi_row, pow_sssi_row)
sssi_counts <- rbind(sssi_counts, dtas_sssi_row)
sssi_counts <- rbind(sssi_counts, transition_sssi_row)
sssi_counts <- rbind(sssi_counts, permaculture_sssi_row)
sssi_counts <- as.data.frame(sssi_counts)
colnames(sssi_counts) <- c("Within SSSIs", "...50m", "...500m")

# Generate dataframe from rows based on percentages of totals
ecs_sssi_row_pct <- ecs_sssi_row/length(ecs)
pow_sssi_row_pct <- pow_sssi_row/length(pow_pointX)
dtas_sssi_row_pct <- dtas_sssi_row/length(dtas)
transition_sssi_row_pct <- transition_sssi_row/length(transition)
permaculture_sssi_row_pct <- permaculture_sssi_row/length(permaculture)

sssi_counts_pct <- rbind(ecs_sssi_row_pct, pow_sssi_row_pct)
sssi_counts_pct <- rbind(sssi_counts_pct, dtas_sssi_row_pct)
sssi_counts_pct <- rbind(sssi_counts_pct, transition_sssi_row_pct)
sssi_counts_pct <- rbind(sssi_counts_pct, permaculture_sssi_row_pct)
colnames(sssi_counts_pct) <- c("% Within SSSIs", "% within 50m", "% within 500m")

# Merge into larger dataframe
sssi_counts_merged <- cbind(sssi_counts, sssi_counts_pct)


# Generate dataframe based on wildland buffers

ecs_wildland_row <- c(sum(apply(st_within(ecs_sf, wildland, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, wildland_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, wildland_buf500, sparse=FALSE), 1, any)))

pow_wildland_row <- c(sum(apply(st_within(pow_pointX_sf, wildland, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, wildland_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, wildland_buf500, sparse=FALSE), 1, any)))
wildland_counts <- rbind(ecs_wildland_row, pow_wildland_row)

dtas_wildland_row <- c(sum(apply(st_within(dtas_sf, wildland, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, wildland_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, wildland_buf500, sparse=FALSE), 1, any)))
wildland_counts <- rbind(wildland_counts, dtas_wildland_row)

transition_wildland_row <- c(sum(apply(st_within(transition_sf, wildland, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, wildland_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, wildland_buf500, sparse=FALSE), 1, any)))
wildland_counts <- rbind(wildland_counts, transition_wildland_row)

permaculture_wildland_row <- c(sum(apply(st_within(permaculture_sf, wildland, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, wildland_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, wildland_buf500, sparse=FALSE), 1, any)))
wildland_counts <- rbind(wildland_counts, permaculture_wildland_row)

colnames(wildland_counts) <- c("Within Wildland Areas", "...50m", "...500m")

# Generate dataframe from rows based on percentages of totals

ecs_wildland_row_pct <- ecs_wildland_row/length(ecs_sf)
pow_wildland_row_pct <- pow_wildland_row/length(pow_pointX)
dtas_wildland_row_pct <- dtas_wildland_row/length(dtas)
transition_wildland_row_pct <- transition_wildland_row/length(transition)
permaculture_wildland_row_pct <- permaculture_wildland_row/length(permaculture)

wildland_counts_pct <- rbind(ecs_wildland_row_pct, pow_wildland_row_pct)
wildland_counts_pct <- rbind(wildland_counts_pct, dtas_wildland_row_pct)
wildland_counts_pct <- rbind(wildland_counts_pct, transition_wildland_row_pct)
wildland_counts_pct <- rbind(wildland_counts_pct, permaculture_wildland_row_pct)
colnames(wildland_counts_pct) <- c("% Within wildlands", "% within 50m", "% within 500m")

# Merge into larger dataframe
wildland_counts_merged <- cbind(wildland_counts, wildland_counts_pct)

# Generate dataframe based on forestinv buffers

ecs_forestinv_row <- c(sum(apply(st_within(ecs_sf, forestinv, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, forestinv_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(ecs_sf, forestinv_buf500, sparse=FALSE), 1, any)))

pow_forestinv_row <- c(sum(apply(st_within(pow_pointX_sf, forestinv, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, forestinv_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(pow_pointX_sf, forestinv_buf500, sparse=FALSE), 1, any)))
forestinv_counts <- rbind(ecs_forestinv_row, pow_forestinv_row)

dtas_forestinv_row <- c(sum(apply(st_within(dtas_sf, forestinv, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, forestinv_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(dtas_sf, forestinv_buf500, sparse=FALSE), 1, any)))
forestinv_counts <- rbind(forestinv_counts, dtas_forestinv_row)

transition_forestinv_row <- c(sum(apply(st_within(transition_sf, forestinv, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, forestinv_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(transition_sf, forestinv_buf500, sparse=FALSE), 1, any)))
forestinv_counts <- rbind(forestinv_counts, transition_forestinv_row)

permaculture_forestinv_row <- c(sum(apply(st_within(permaculture_sf, forestinv, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, forestinv_buf50, sparse=FALSE), 1, any)), sum(apply(st_within(permaculture_sf, forestinv_buf500, sparse=FALSE), 1, any)))
forestinv_counts <- rbind(forestinv_counts, permaculture_forestinv_row)

colnames(forestinv_counts) <- c("Within Woodlands", "...50m", "...500m")

# Generate dataframe from rows based on percentages of totals
ecs_forestinv_row_pct <- ecs_forestinv_row/length(ecs_sf)
pow_forestinv_row_pct <- pow_forestinv_row/length(pow_pointX)
dtas_forestinv_row_pct <- dtas_forestinv_row/length(dtas)
transition_forestinv_row_pct <- transition_forestinv_row/length(transition)
permaculture_forestinv_row_pct <- permaculture_forestinv_row/length(permaculture)

forestinv_counts_pct <- rbind(ecs_forestinv_row_pct, pow_forestinv_row_pct)
forestinv_counts_pct <- rbind(forestinv_counts_pct, dtas_forestinv_row_pct)
forestinv_counts_pct <- rbind(forestinv_counts_pct, transition_forestinv_row_pct)
forestinv_counts_pct <- rbind(forestinv_counts_pct, permaculture_forestinv_row_pct)
colnames(forestinv_counts_pct) <- c("% Within Woodlands", "% within 50m", "% within 500m")

# Merge into larger dataframe
forestinv_counts_merged <- cbind(forestinv_counts, forestinv_counts_pct)

```

# Proximity to "Wilderness"

Chasing down a curiosity, I decided to try and calculate whether proximity to "wilderness" or "scenic nature" or just trees might have some impact on generating more mobilised communities. I realised that there would be several problems with this kind of calculation up front, first being that "nature" is a deeply problematic construct, reviled by geographers and philosophers alike. With this in mind, I identified several different ways of reckoning wilderness, starting with the highly anachronistic "Scenic Land" designation from the 1970s. Then I pursued the more carefully calculated "core wild areas" generated by SNH just a few years ago. However, even the core wile areas concept has been criticised heavily, so I also expanded out my search to include all sites of special scientific interest and then went even wider to include the Scottish Forestry Service's "Native Woodland" and finally, the most generic possible measurement, any land identified as forested at the last Forest Inventory.

Proximity to these areas was the next concern, because many of these designations deliberately exclude human habitat, so it was necessary to measure the number of sites within proximity. There is a question which lies here regarding aesthetics, namely, what sort of proximity might generate an affective connection? From my own experience, I decided upon the distance represented by a short walk, i.e. a half-kilometre. However, with the more generic measurements, such as SSSI and forestation, this wouldn't do, as there are so many of these sites that a buffer of 500 meters encapsulates almost all of inhabited Scotland. So for these sites I also calculated a count within 50 metres.

So what did I discover? The results were inconclusive. First, it is important to note that on the whole, Eco-Congregations tend to be more urban than place of worship taken generally at a rate of nearly 3:1 (5.4% of Eco-Congregations lie in areas currently designated as "Very Remote Rural Areas" whereas nearly 15% of places of worship lie in these areas), so what I was testing for was whether this gap was smaller when specifying these various forms of "wild" remoteness. For our narrowest measurements, there were so few sites captured as to render measurement unreliable. There are, for obvious reasons, `st_within(ecs_sf, wildland)` sites located within any of SNG's core wild areas. Similarly, there are very few of our activist communities located within SSSI's (only `st_within(pow_pointX_sf, sssi)` places of worship out of `r length(pow_pointX)`, `st_within(transition_sf, sssi)` transition towns, (or 2%) and `st_within(dtas_sf, sssi)` community development trusts (3%)). However, expanding this out makes things a bit more interesting, within 50 metres of SSSI's in Scotland lie `st_within(ecs_sf, sssi_buf50)` Eco-Congregations (or just under 1%), which compares favourably with the `st_within(pow_pointX_sf, sssi_buf50)` places of worship (or just 1.5%) far exceeding our ratio (1:1.5 vs. 1:3). This is the same with our more anachronistic measure of "scenic areas," there are 7 eco-congregations within these areas, and 175 places of worship, making for a ratio of nearly 1:2 (2.1% vs. 4.3%). Taking our final measure, of forested areas, this is hard to calculate, as only `st_within(ecs_sf, forestinv)` Eco-Congregation lies within either native or generally forested land.

```{r wilderness_tables} 

# Output mmd tables using kable

sssi_counts_merged %>%
  kable(format = "html", col.names = colnames(sssi_counts_merged), caption = "Group counts within SSSIs") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", full_width = F, "responsive"))

wildland_counts_merged %>%
  kable(format = "html", col.names = colnames(wildland_counts_merged), caption = "Group counts within Wildland Areas") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", full_width = F, "responsive"))

forestinv_counts_merged %>%
  kable(format = "html", col.names = colnames(forestinv_counts_merged), caption = "Group counts within woodlands") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", full_width = F, "responsive"))

# Output CSV files for tables above
write.csv(sssi_counts_merged, "derivedData/sssi_counts_merged.csv", row.names=TRUE)
write.csv(wildland_counts_merged, "derivedData/wildland_counts_merged.csv", row.names=TRUE)
write.csv(forestinv_counts_merged, "derivedData/forestinv_counts_merged.csv", row.names=TRUE)

```


```{r sssi_ecs_buffer_plot, message=FALSE, warning=FALSE, fig.width=4, fig.cap="Figure 11"}

# Plot SSSI polygons (showing buffers) with ECS points (coloured by location)

tm_shape(sssi_simplified) + 
  tm_fill(col = "green", alpha = 0.3, lwd=0.001) + 
#  tm_shape(sssi_buf50) + tm_borders(lwd=0.001) +
#  tm_shape(sssi_buf500) + tm_borders(lwd=0.001)
  tm_shape(admin_lev1_sf) + tm_borders(lwd=0.1) +
  tm_shape(ecs_sf) + tm_dots("red", size = .05, alpha = .4) +
#  tm_shape(ecs_sf_sssi50m) + tm_dots("yellow", size = .5, alpha = .4) + 
#  tm_shape(ecs_sf_sssi500m) + tm_dots("orange", size = .5, alpha = .4) +
#  tm_shape(ecs_sf_sssibeyond500m) + tm_dots("red", size = .5, alpha = .4)
  tm_scale_bar(position = c("left", "bottom")) +
  tm_style("gray", title = "Figure 11") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Sites of Special Scientific Interest and ECS Groups", 
            frame = FALSE, 
            title.size = .7
            )


```

```{r all_wilderness_ecs_plot, message=FALSE, warning=FALSE, fig.width=4, fig.cap="Figure 12"}

# Plot map with all wilderness shapes on it

tm_shape(sssi_simplified) + tm_fill(col = "blue", alpha = 0.3, lwd=0.001) + 
  tm_shape(wildland_simplified) + tm_fill(col = "green", alpha = 0.3, lwd=0.001) + 
  tm_shape(forestinv_simplified) + tm_fill(col = "orange", alpha = 0.3, lwd=0.001) + 
  tm_scale_bar(breaks = c(0, 100, 200), size = 1) +
  tm_shape(ecs_sf) + tm_dots("red", size = .05, alpha = .4) +
  tm_scale_bar(position = c("left", "bottom")) +
  tm_style("gray", title = "Figure 12") +
  tm_credits("Data: UK Data Service (OGL)
              & Jeremy H. Kidwell,
              Graphic is CC-by-SA 4.0",
    position = c("right", "bottom")) +
  tm_layout(title = "Wilderness Areas", 
            frame = FALSE, 
            title.size = .7
            )

```


# Appendix A

```{r admin_table}
# Output CSV files for various levels of admin
write.csv(admin_lev1, "derivedData/admin_lev1.csv", row.names=FALSE)
write.csv(admin_lev2, "derivedData/admin_lev2.csv", row.names=FALSE)
write.csv(ecs, "derivedData/ecs.csv", row.names=FALSE)
write.csv(transition, "derivedData/transition.csv", row.names=FALSE)
write.csv(permaculture, "derivedData/permaculture.csv", row.names=FALSE)
write.csv(dtas, "derivedData/dtas.csv", row.names=FALSE)
write.csv(simd, "derivedData/simd.csv", row.names=FALSE)

# Output mmd tables using kable
admin_lev1_df <- as_data_frame(admin_lev1[,c(3,5,7,11,13)])

admin_lev1_df %>%
  kable(format = "html", col.names = colnames(admin_lev1_df)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "800px")
```

# Appendix B

```{r admin_table_withproportions}

admin_lev1_prop_df <- as_data_frame(admin_lev1[,c(3:14,23:26)])

admin_lev1_prop_df %>%
  kable(format = "html", col.names = colnames(admin_lev1_prop_df)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%", height = "800px")
```

# Appendix C - Data by Urban / Rural Classification

```{r urbanrural_table}
# Output CSV files for urbanrural tables
write.csv(urbanrural, "derivedData/urbanrural.csv", row.names=FALSE)

# Output mmd tables using kable

urbanrural_table <- as_data_frame(urbanrural[,c(1,7:16)])

urbanrural_table %>%
  kable(format = "html", col.names = colnames(urbanrural_table)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
    kableExtra::scroll_box(width = "100%")

```

# Citations

[^15541312]: This research was jointly funded by the AHRC/ESRC under project numnbers AH/K005456/1 and AH/P005063/1.
[^158261118]: This is not to say that there have been no collaborations before 2000, noteworthy in this respect is the WWF who helped to found the Alliance of Religion and Conservation (ARC) in 1985.
[^159141043]: This suggestion should be qualified - RSPB would greatly exceed ECS both in terms of the number of individual subscribers and budget. The RSPB trustee's report for 2013-2014 suggests that their member base was 1,114,938 people across Britain with a net income of 127m - the latter of which exceeds the Church of Scotland. If we adjust this based on the Scottish share of the population of the United Kingdom as of the 2011 census (8.3%) this leaves us with an income of 9.93m. The British charity commission requires charities to self-report the number of volunteers and staff, and from their most recent statistics we learn that RSPB engaged with 17,600 volunteers and employed 2,110 members of staff. Again, adjusted for population, this leaves 1,460 volunteers in Scotland and 176 staff. However, if we measure environmental groups based on the number of sites they maintain, RSPB has only 40 reserves with varying levels of local community engagement. For comparison, as of Sep 14 2015, Friends of the Earth Scotland had only 10 local groups (concentrated mostly in large urban areas). Depending on how one measures "volunteerism," it may be possible that ECS has more engaged volunteers in Scotland as well - if each ECS group had only 4 "volunteers" then this would exceed RSPB.
[^15541313]: Kidwell, Jeremy. (2016). Eco-Congregation Scotland, 2014-2016. University of Edinburgh. http://dx.doi.org/10.7488/ds/1357.
[^15541342]:My dataset on transition towns will be made available later in 2016. Initial data was aquired from the Transition Scotland website http://www.transitionscotland.org/transition-in-scotland on December 10, 2014. We are currently in the process of collaboratively generating a more up-to-date dataset which will reflect their collaboration with SCCAN.
[^177171536]: For further detail on Dataset generation, see Kidwell, Forthcoming, 2018.
[^158261232]:Data was acquired from the Development Trusts Association website, http://www.dtascot.org.uk, accessed on 20 July 2015. As above, we are currently in the process of active collaboration with volunteers from the DTAS to co-generate a new dataset.
[^15541614]:PointX data for "Landscape Data" items is sourced from Ordnance Survey Land-Line and MasterMap(R) and the data points are augmented with additional information provided through research by PointX staff, and data aquired from unidentified "local data companie(s)" and the "118 Information" database (see: http://www.118information.co.uk). This data is under license and cannot be made available for use. It is important to note that I became aware of inaccuracies in this dataset over the course of use and subsequently generated my own dataset in collaboration with churches in Scotland. This will be made available later in 2016. I am in active conversation with OS about improving the quality of the data in PointX regarding places of worship.
[^15826124]:Interview with Margaret Warnock, 29 Aug 2014.
[^158261210]:From http://www.forthenvironmentlink.org, accessed 12 July 2015.
[^1554162]:From the Transition map key, "Green pins are 'official' groups
Blue pins are active communities who are connected to the Scottish Transition network Yellow pins show interest in this area"
[^15571030]:This was calculated by calculating a 10m wide footprint for every postcode in Scotland, areas which are not within 10m of a postcode (as of May 2014) are counted as uninhabited.
[^159142242]: Fiona Tweedie, *Ecumenical Audit: Questionnaire Findings* (2014). 
[^15914204]:See note above regarding the data used from the PointX POI database. Note, for our research,we filtered out religious groups not represented within the Eco-Congregation footprint. We discuss representation by tradition and religion further below.adition and religion further below.
